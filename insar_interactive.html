<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Traitement du Signal ‚Äî S√©ries Temporelles InSAR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Syne:wght@400;600;700;800&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap');
  :root{--bg:#0b0f1a;--surface:#111827;--surface2:#1a2235;--border:#1e2d45;--accent:#38bdf8;--accent2:#f59e0b;--accent3:#34d399;--accent4:#f472b6;--text:#e2e8f0;--muted:#64748b;--code-bg:#0d1117;}
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:17px;line-height:1.7;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(56,189,248,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{max-width:960px;margin:0 auto;padding:60px 24px;position:relative;z-index:1;}
  header{border-bottom:1px solid var(--border);padding-bottom:40px;margin-bottom:60px;}
  .tag-line{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:16px;display:flex;align-items:center;gap:10px;}
  .tag-line::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--accent) 0%,transparent 100%);opacity:0.3;}
  h1{font-family:'Syne',sans-serif;font-weight:800;font-size:clamp(28px,5vw,48px);line-height:1.1;color:#fff;margin-bottom:12px;}
  h1 span{color:var(--accent);}
  .subtitle{font-size:18px;color:var(--muted);font-style:italic;margin-bottom:24px;}
  .meta-row{display:flex;gap:24px;flex-wrap:wrap;}
  .meta-item{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;}
  .meta-item span{color:var(--text);}
  .section{margin-bottom:64px;}
  .section-header{display:flex;align-items:flex-start;gap:20px;margin-bottom:28px;}
  .section-num{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);background:rgba(56,189,248,0.08);border:1px solid rgba(56,189,248,0.2);border-radius:4px;padding:4px 8px;white-space:nowrap;margin-top:6px;}
  h2{font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:#fff;line-height:1.3;}
  h3{font-family:'Syne',sans-serif;font-weight:600;font-size:16px;color:var(--accent2);margin:24px 0 10px;text-transform:uppercase;letter-spacing:1px;}
  .theory{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;padding:20px 24px;margin-bottom:20px;}
  .theory p{margin-bottom:10px;}.theory p:last-child{margin-bottom:0;}
  .formula{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px 20px;font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--accent3);margin:16px 0;text-align:center;letter-spacing:0.5px;}
  .exercise{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px;}
  .exercise-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:12px;}
  .ex-badge{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;padding:3px 8px;border-radius:3px;background:rgba(245,158,11,0.15);color:var(--accent2);border:1px solid rgba(245,158,11,0.3);}
  .exercise-title{font-family:'Syne',sans-serif;font-weight:600;font-size:14px;color:var(--text);}
  .exercise-body{padding:20px;}
  .question{font-size:15px;color:var(--text);margin-bottom:16px;padding-left:12px;border-left:2px solid var(--muted);}
  .controls{display:flex;flex-wrap:wrap;gap:16px;margin:16px 0;align-items:flex-end;}
  .control-group{display:flex;flex-direction:column;gap:6px;}
  .control-group label{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
  input[type=range]{-webkit-appearance:none;width:160px;height:4px;border-radius:2px;background:var(--border);outline:none;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;transition:background 0.2s;}
  input[type=range]::-webkit-slider-thumb:hover{background:#7dd3fc;}
  .value-display{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent);min-width:50px;text-align:right;}
  .chart-wrapper{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin:16px 0;position:relative;}
  .chart-wrapper canvas{max-height:220px;}
  .btn{font-family:'JetBrains Mono',monospace;font-size:12px;text-transform:uppercase;letter-spacing:1px;padding:8px 16px;border-radius:5px;border:1px solid var(--accent);background:rgba(56,189,248,0.08);color:var(--accent);cursor:pointer;transition:all 0.2s;}
  .btn:hover{background:rgba(56,189,248,0.18);box-shadow:0 0 12px rgba(56,189,248,0.2);}
  .btn-green{border-color:var(--accent3);background:rgba(52,211,153,0.08);color:var(--accent3);}
  .btn-green:hover{background:rgba(52,211,153,0.18);}
  .answer-toggle{margin-top:12px;}
  .answer-content{display:none;margin-top:12px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.2);border-radius:6px;padding:16px;font-size:15px;}
  .answer-content.visible{display:block;}
  .answer-content ul{padding-left:18px;margin-top:8px;}.answer-content li{margin-bottom:6px;}
  .code-block{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.8;overflow-x:auto;margin:16px 0;color:#94a3b8;}
  .code-block .kw{color:#c792ea;}.code-block .fn{color:#82aaff;}.code-block .str{color:#c3e88d;}.code-block .cm{color:#546e7a;font-style:italic;}.code-block .num{color:#f78c6c;}
  .note{background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.2);border-radius:6px;padding:12px 16px;font-size:14px;color:#fde68a;display:flex;gap:10px;margin:12px 0;}
  .sep{border:none;border-top:1px solid var(--border);margin:48px 0;}
  .legend{display:flex;flex-wrap:wrap;gap:16px;margin:10px 0;font-family:'JetBrains Mono',monospace;font-size:11px;}
  .legend-item{display:flex;align-items:center;gap:6px;color:var(--muted);}
  .legend-dot{width:20px;height:3px;border-radius:2px;}
  .progress-bar{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width 0.3s;z-index:100;}
  code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(56,189,248,0.08);color:var(--accent);padding:1px 5px;border-radius:3px;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin:16px 0;}
  th{font-family:'JetBrains Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:left;padding:8px 12px;border-bottom:1px solid var(--border);}
  td{padding:8px 12px;border-bottom:1px solid rgba(30,45,69,0.5);}
  tr:last-child td{border-bottom:none;}
  .tag{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 6px;border-radius:3px;background:rgba(52,211,153,0.1);color:var(--accent3);border:1px solid rgba(52,211,153,0.2);}
  /* CWT Canvas */
  #cwt-canvas-wrapper{position:relative;width:100%;background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin:16px 0;}
  #cwtCanvas{width:100%;height:200px;display:block;}
  .cwt-yaxis{position:absolute;left:0;top:0;height:100%;display:flex;flex-direction:column;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);padding:12px 4px;}
</style>
</head>
<body>
<div class="progress-bar" id="progressBar"></div>
<div class="container">

<!-- HEADER -->
<header>
  <div class="tag-line">Cours ¬∑ Notebook Interactif ¬∑ ~30 min</div>
  <h1>Traitement du Signal<br><span>S√©ries Temporelles InSAR</span></h1>
  <p class="subtitle">D√©composition, d√©tection de fr√©quences variables et corr√©lations crois√©es</p>
  <div class="meta-row">
    <div class="meta-item">üì° Donn√©es : <span>InSAR LOS</span></div>
    <div class="meta-item">üîß M√©thodes : <span>FFT ¬∑ STL ¬∑ CWT ¬∑ Corr√©lation</span></div>
  </div>
</header>

<!-- ¬ß01 FONDAMENTAUX -->
<div class="section">
  <div class="section-header">
    <div class="section-num">01</div>
    <div><h2>Fondamentaux ‚Äî Qu'est-ce qu'un signal InSAR ?</h2></div>
  </div>
  <div class="theory">
    <p>Une s√©rie temporelle InSAR mesure le <strong>d√©placement du sol dans la direction LOS</strong> (en mm), √† raison d'une acquisition toutes les 6‚Äì12 jours (Sentinel-1). Sur un pixel, on observe un signal multifr√©quentiel :</p>
    <p><strong>Signal total = Tendance longue + Saisonnalit√© + R√©sidu</strong></p>
    <p>Les origines peuvent √™tre tectoniques, g√©ologiques, hydrologiques, thermiques ou atmosph√©riques. L'analyse fr√©quencielle permet de les distinguer.</p>
  </div>
  <div class="formula">d(t) = T(t) + S<sub>annuel</sub>(t) + S<sub>semi-annuel</sub>(t) + Œµ(t)</div>
  <h3>Composition d'un signal synth√©tique</h3>
  <div class="exercise">
    <div class="exercise-header"><div class="ex-badge"></div><div class="exercise-title">Construire et identifier les composantes d'un signal InSAR</div></div>
    <div class="exercise-body">
      <div class="question">Ajustez les param√®tres ci-dessous. Observez comment chaque composante contribue au signal total.</div>
      <div class="controls">
        <div class="control-group"><label>Tendance (mm/an)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s1trend" min="-15" max="15" value="5" step="0.5"><div class="value-display" id="s1trendVal">5</div></div></div>
        <div class="control-group"><label>Amplitude annuelle (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s1amp1" min="0" max="20" value="8" step="0.5"><div class="value-display" id="s1amp1Val">8</div></div></div>
        <div class="control-group"><label>Amplitude semi-annuelle (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s1amp2" min="0" max="10" value="3" step="0.5"><div class="value-display" id="s1amp2Val">3</div></div></div>
        <div class="control-group"><label>Bruit œÉ (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s1noise" min="0" max="5" value="1.5" step="0.1"><div class="value-display" id="s1noiseVal">1.5</div></div></div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div>Signal total</div>
        <div class="legend-item"><div class="legend-dot" style="background:#f59e0b;opacity:0.7"></div>Tendance</div>
        <div class="legend-item"><div class="legend-dot" style="background:#34d399;opacity:0.7"></div>Saisonnalit√© annuelle</div>
      </div>
      <div class="chart-wrapper"><canvas id="chart1"></canvas></div>
      <div class="answer-toggle"><button class="btn btn-green" onclick="toggleAnswer('ans1')">‚ñ∑ Points cl√©s √† retenir</button>
        <div class="answer-content" id="ans1"><ul>
          <li><strong>La tendance</strong> repr√©sente le d√©placement "permanent" : affaissement, soul√®vement tectonique, compaction</li>
          <li><strong>La saisonnalit√© annuelle</strong> (~1/an) est li√©e aux variations de charge hydrique, dilatations thermiques</li>
          <li><strong>Le semi-annuel</strong> (~2/an) peut refl√©ter deux cycles de fonte ou des effets atmosph√©riques</li>
          <li><strong>Avec bruit œÉ > amplitude</strong> ‚Üí la tendance est difficile √† extraire sans filtrage</li>
        </ul></div>
      </div>
    </div>
  </div>
</div>

<hr class="sep">

<!-- ¬ß02 FFT -->
<div class="section">
  <div class="section-header">
    <div class="section-num">02</div>
    <div><h2>Analyse spectrale ‚Äî Transform√©e de Fourier (FFT)</h2></div>
  </div>
  <div class="theory">
    <p>La <strong>FFT</strong> d√©compose un signal en ses fr√©quences constituantes. Elle suppose la <em>stationnarit√©</em> ‚Äî les propri√©t√©s statistiques ne changent pas dans le temps. Pour un signal InSAR de 5 ans (N‚âà300 pts), la r√©solution fr√©quentielle est 1/5 = 0.2 cycle/an. Cela signifie que la FFT teste les fr√©quences : 0.2, 0.4, 0.6, 0.8, 1.0, ... </p>
  </div>
  <div class="formula">X(f) = Œ£ x(t) ¬∑ e<sup>‚àí2œÄift</sup> &nbsp;‚Üí&nbsp; |X(f)|¬≤ = Densit√© Spectrale de Puissance</div>
  <h3>Lecture d'un spectre de puissance</h3>
  <div class="exercise">
    <div class="exercise-header"><div class="ex-badge"></div><div class="exercise-title">Identifier les fr√©quences dominantes dans un spectre FFT</div></div>
    <div class="exercise-body">
      <div class="question">Ajoutez des composantes et observez les pics dans le domaine fr√©quentiel. √Ä quelle fr√©quence attendez-vous les pics pour l'annuel et le semi-annuel ?</div>
      <div class="controls">
        <div class="control-group"><label>Fr√©quence 1 (c/an)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s2f1" min="0.5" max="4" value="1" step="0.5"><div class="value-display" id="s2f1Val">1.0</div></div></div>
        <div class="control-group"><label>Amplitude 1 (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s2a1" min="0" max="20" value="10"><div class="value-display" id="s2a1Val">10</div></div></div>
        <div class="control-group"><label>Fr√©quence 2 (c/an)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s2f2" min="0.5" max="4" value="2" step="0.5"><div class="value-display" id="s2f2Val">2.0</div></div></div>
        <div class="control-group"><label>Amplitude 2 (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s2a2" min="0" max="20" value="5"><div class="value-display" id="s2a2Val">5</div></div></div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div>Signal temporel</div>
        <div class="legend-item"><div class="legend-dot" style="background:#f472b6"></div>Spectre de puissance</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="chart-wrapper"><canvas id="chart2a"></canvas></div>
        <div class="chart-wrapper"><canvas id="chart2b"></canvas></div>
      </div>
      <div class="note">‚ö†Ô∏è <span>f=1 c/an ‚Üí T=12 mois (annuel). f=2 c/an ‚Üí T=6 mois (semi-annuel). La hauteur du pic est proportionnelle √† l'√©nergie (amplitude¬≤).</span></div>
      <div class="answer-toggle"><button class="btn btn-green" onclick="toggleAnswer('ans2')">‚ñ∑ Points cl√©s</button>
        <div class="answer-content" id="ans2"><ul>
          <li><strong>f = 1 c/an ‚Üí T = 12 mois</strong> : saisonnalit√© annuelle (neige, aquif√®res)</li>
          <li><strong>f = 2 c/an ‚Üí T = 6 mois</strong> : semi-annuel</li>
          <li>Limite : si la fr√©quence <em>varie dans le temps</em>, le pic s'√©largit ‚Äî la FFT perd en pr√©cision</li>
        </ul></div>
      </div>
    </div>
  </div>
</div>

<hr class="sep">

<!-- ¬ß03 STL -->
<div class="section">
  <div class="section-header">
    <div class="section-num">03</div>
    <div><h2>D√©composition STL ‚Äî Extraire tendance et saisonnalit√©</h2></div>
  </div>
  <div class="theory">
    <p><strong>STL (Seasonal-Trend decomposition using LOESS)</strong> d√©compose it√©rativement un signal en 3 composantes via des r√©gressions locales pond√©r√©es. Robuste aux donn√©es manquantes et aux outliers, sans hypoth√®se de stationnarit√©.</p>
  </div>
  <div class="code-block">

  <h3>Effet de la fen√™tre LOESS (compromis biais/variance)</h3>
  <div class="exercise">
    <div class="exercise-header"><div class="ex-badge"></div><div class="exercise-title">Observer le compromis biais/variance de la fen√™tre LOESS</div></div>
    <div class="exercise-body">
      <div class="question">La largeur de la fen√™tre LOESS contr√¥le le compromis biais/variance. La variance correspond au "lissage" du signal tandis que le biais correspond √† l'√©cart √† la r√©alit√© de la tendance ou de la saisonnalit√©. Comparez la tendance extraite avec la vraie tendance pour diff√©rentes fen√™tres.</div>
      <div class="controls">
        <div class="control-group"><label>Fen√™tre LOESS (mois)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s3win" min="3" max="36" value="12" step="3"><div class="value-display" id="s3winVal">12</div></div></div>
        <div class="control-group"><label>Bruit œÉ (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s3noise" min="0" max="8" value="3" step="0.5"><div class="value-display" id="s3noiseVal">3</div></div></div>
        <div class="control-group"><label>Type de tendance</label>
          <select id="s3type" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:'JetBrains Mono',monospace;font-size:12px">
            <option value="linear">Lin√©aire</option>
            <option value="break">Rupture (saut)</option>
            <option value="accel">Acc√©l√©ration</option>
          </select>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#475569"></div>Signal bruit√©</div>
        <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Vraie tendance</div>
        <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div>Tendance extraite (LOESS)</div>
      </div>
      <div class="chart-wrapper"><canvas id="chart3"></canvas></div>
      <div class="answer-toggle"><button class="btn btn-green" onclick="toggleAnswer('ans3')">‚ñ∑ Points cl√©s</button>
        <div class="answer-content" id="ans3"><ul>
          <li><strong>Fen√™tre √©troite (3 mois)</strong> : sur-ajustement ‚Üí variance √©lev√©e, biais faible. La tendance suit trop le bruit mais les d√©tails sont mieux captur√©s.</li>
          <li><strong>Fen√™tre large (36 mois)</strong> : lissage important ‚Üí biais √©lev√©, variance faible. La tendance est liss√©e mais les d√©tails ne sont pas bien captur√©s.</li>
          <li><strong>En cas r√©el</strong> : on adapte la fen√™tre au ph√©nom√®ne que l'on veut observer.</li>
          <li><strong>Cas rupture</strong> : STL lisse la transition ‚Üí compl√©ter avec BFAST ou d√©tection de rupture</li>
        </ul></div>
      </div>
    </div>
  </div>
</div>

<hr class="sep">

<!-- ¬ß04 CWT -->
<div class="section">
  <div class="section-header">
    <div class="section-num">04</div>
    <div><h2>Fr√©quences variables dans le temps ‚Äî Transform√©e en Ondelettes (CWT)</h2></div>
  </div>
  <div class="theory">
    <p>La <strong>Transform√©e en Ondelettes Continue (CWT)</strong> analyse comment les fr√©quences d'un signal √©voluent au cours du temps. Contrairement √† la FFT, sa r√©solution est <em>adaptive</em> : fine aux hautes fr√©quences, grossi√®re aux basses fr√©quences ‚Äî id√©al pour les signaux InSAR non-stationnaires.</p>
    <p>Le <strong>scalogramme</strong> |W(a,b)|¬≤ visualise l'√©nergie dans l'espace temps‚Äìfr√©quence.</p>
  </div>
  <div class="formula">W(a, b) = 1/‚àöa ¬∑ ‚à´ x(t) ¬∑ œà*((t‚àíb)/a) dt &nbsp;&nbsp;‚Üí&nbsp;&nbsp; Scalogramme = |W|¬≤</div>
  <h3>Scalogramme CWT interactif</h3>
  <div class="exercise">
    <div class="exercise-header"><div class="ex-badge"></div><div class="exercise-title">D√©tecter une transition fr√©quentielle avec le scalogramme</div></div>
    <div class="exercise-body">
      <div class="question">
        Simulez un signal non-stationnaire dont la fr√©quence dominante change √† mi-parcours (nappe phr√©atique passant de 1 √† 2 cycles/an). Le scalogramme doit montrer clairement <em>quand</em> la transition a lieu ‚Äî ce que la FFT seule ne peut pas faire.
      </div>
      <div class="controls">
        <div class="control-group"><label>Fr√©quence phase 1 (c/an)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s4f1" min="0.5" max="3" value="1" step="0.5"><div class="value-display" id="s4f1Val">1.0</div></div></div>
        <div class="control-group"><label>Fr√©quence phase 2 (c/an)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s4f2" min="0.5" max="3" value="2" step="0.5"><div class="value-display" id="s4f2Val">2.0</div></div></div>
        <div class="control-group"><label>Amplitude (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s4amp" min="2" max="15" value="8" step="1"><div class="value-display" id="s4ampVal">8</div></div></div>
        <div class="control-group"><label>Bruit œÉ (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s4noise" min="0" max="5" value="1.5" step="0.5"><div class="value-display" id="s4noiseVal">1.5</div></div></div>
      </div>

      <!-- Signal temporel -->
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div>Signal non-stationnaire</div>
        <div class="legend-item" style="font-size:10px;color:var(--muted)">‚îä ligne pointill√©e = transition √† t=3 ans</div>
      </div>
      <div class="chart-wrapper"><canvas id="chart4sig" style="max-height:160px"></canvas></div>

      <!-- Scalogramme canvas -->
      <div style="margin:8px 0 4px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent3)">Scalogramme CWT (Morlet) ‚Äî Puissance |W|¬≤ en fonction du temps et de la fr√©quence</div>
      <div id="cwt-canvas-wrapper">
        <canvas id="cwtCanvas"></canvas>
      </div>
      <div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-top:-8px;padding:0 4px">
        <span>t = 0 an</span><span>t = 3 ans (transition)</span><span>t = 6 ans</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted)">
        <span>Faible</span>
        <div style="width:120px;height:8px;border-radius:4px;background:linear-gradient(90deg,#1a0533,#7c3aed,#f59e0b,#fef9c3)"></div>
        <span>Forte puissance</span>
      </div>

      <!-- FFT comparative -->
      <div style="margin-top:16px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent4)">FFT globale ‚Äî les deux fr√©quences apparaissent mais sans info temporelle</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:#f472b6;margin:6px 0 3px;text-align:center">Spectre ‚Äî 1√®re moiti√©</div>
          <div class="chart-wrapper" style="margin:0"><canvas id="chart4fft1" style="max-height:150px"></canvas></div>
        </div>
        <div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:#f59e0b;margin:6px 0 3px;text-align:center">Spectre ‚Äî 2√®me moiti√©</div>
          <div class="chart-wrapper" style="margin:0"><canvas id="chart4fft2" style="max-height:150px"></canvas></div>
        </div>
      </div>

      <div class="note">‚ö†Ô∏è <span><strong>Principe d'incertitude</strong> : la CWT offre une r√©solution adaptive ‚Äî meilleure aux hautes fr√©quences (fen√™tre courte) et raisonnable aux basses fr√©quences (fen√™tre longue). Les <strong>bords temporels</strong> sont moins fiables (c√¥ne d'influence).</span></div>

      <div class="answer-toggle"><button class="btn btn-green" onclick="toggleAnswer('ans4')">‚ñ∑ Points cl√©s √† retenir</button>
        <div class="answer-content" id="ans4"><ul>
          <li><strong>Bande horizontale continue</strong> = fr√©quence pr√©sente sur toute la dur√©e (signal stationnaire)</li>
          <li><strong>Bande qui appara√Æt / dispara√Æt</strong> = changement de r√©gime (transition hydrologique, acc√©l√©ration)</li>
          <li><strong>La FFT globale montre les deux fr√©quences</strong> mais ne peut pas dire <em>quand</em> la transition a lieu</li>
          <li><strong>Avantage CWT vs STFT</strong> : r√©solution adaptive, pas besoin de choisir une fen√™tre fixe ‚Äî meilleure pr√©cision simultan√©e en temps et en fr√©quence</li>
          <li>Ondelette <strong>Morlet</strong> recommand√©e pour l'InSAR (signal quasi-sinuso√Ødal)</li>
        </ul></div>
      </div>
    </div>
  </div>
</div>

<hr class="sep">

<!-- ¬ß05 CCF -->
<div class="section">
  <div class="section-header">
    <div class="section-num">05</div>
    <div><h2>Corr√©lation crois√©e ‚Äî Identifier les facteurs for√ßants</h2></div>
  </div>
  <div class="theory">
    <p>La corr√©lation crois√©e mesure la similarit√© entre deux signaux d√©cal√©s dans le temps. Si un facteur externe force la d√©formation, on s'attend √† un pic de corr√©lation √† un d√©lai œÑ &gt; 0 ‚Äî le temps de transfert entre for√ßage et r√©ponse.</p>
  </div>
  <div class="formula">CCF(œÑ) = ‚ü®x(t) ¬∑ y(t + œÑ)‚ü© / (œÉ<sub>x</sub> ¬∑ œÉ<sub>y</sub>) &nbsp;‚Üí&nbsp; œÑ<sub>max</sub> = d√©lai de r√©ponse</div>
  <h3>D√©lai de r√©ponse hydrom√©canique</h3>
  <div class="exercise">
    <div class="exercise-header"><div class="ex-badge">Exercice</div><div class="exercise-title">Estimer le d√©lai de r√©ponse</div></div>
    <div class="exercise-body">
      <div class="question">Simulez un signal InSAR (r√©sidu STL) r√©pondant √† un for√ßage avec un d√©lai. La CCF permet d'estimer ce d√©lai m√™me quand la relation n'est pas visible √† l'≈ìil nu.</div>
      <div class="controls">
        <div class="control-group"><label>D√©lai r√©el (mois)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s5lag" min="0" max="6" value="2" step="0.5"><div class="value-display" id="s5lagVal">2</div></div></div>
        <div class="control-group"><label>Bruit InSAR œÉ (mm)</label><div style="display:flex;align-items:center;gap:8px"><input type="range" id="s5noise" min="0" max="8" value="2" step="0.5"><div class="value-display" id="s5noiseVal">2</div></div></div>
        <div class="control-group"><label>Facteur de for√ßage</label>
          <select id="s5type" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:'JetBrains Mono',monospace;font-size:12px">
            <option value="rain">Pr√©cipitations</option>
            <option value="piezo">Niveau pi√©zom√©trique</option>
            <option value="snow">Fonte des neiges</option>
          </select>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div>InSAR r√©sidu</div>
        <div class="legend-item"><div class="legend-dot" style="background:#4ade80"></div>Signal for√ßant</div>
      </div>
      <div class="chart-wrapper"><canvas id="chart5a"></canvas></div>
      <div style="margin-top:12px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent4)">Fonction de Corr√©lation Crois√©e CCF(œÑ)</div>
      <div class="chart-wrapper"><canvas id="chart5b"></canvas></div>
      <div id="corrResult" style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent3);padding:10px;background:rgba(52,211,153,0.05);border-radius:6px;border:1px solid rgba(52,211,153,0.2);margin-top:10px"></div>
      <div class="answer-toggle"><button class="btn btn-green" onclick="toggleAnswer('ans5')">‚ñ∑ Points cl√©s</button>
        <div class="answer-content" id="ans5"><ul>
          <li>La CCF d√©tecte le d√©lai m√™me quand le signal est bruit√© (SNR > 6 dB)</li>
          <li><strong>Toujours travailler sur une courbe o√π la tendance √† √©t√© enlev√©e</strong> : la tendance commune entre deux s√©ries peut produire une fausse corr√©lation</li>
          <li>D√©lai n√©gatif = InSAR pr√©c√®de le for√ßant</li>
        </ul></div>
      </div>
    </div>
  </div>
</div>

<hr class="sep">

<!-- ¬ß06 SYNTH√àSE -->
<div class="section">
  <div class="section-header">
    <div class="section-num">06</div>
    <div><h2>Synth√®se</h2></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0">
    <div style="background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent);border-radius:8px;padding:16px">
      <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">√âtape 1 ¬∑ Explorer</div>
      <div style="font-family:'Syne',sans-serif;font-weight:600;margin-bottom:8px">FFT globale</div>
      <div style="font-size:14px;color:var(--muted)">Identifier les fr√©quences dominantes. Visualiser signal brut.</div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent2);border-radius:8px;padding:16px">
      <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent2);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">√âtape 2 ¬∑ D√©composer</div>
      <div style="font-family:'Syne',sans-serif;font-weight:600;margin-bottom:8px">STL + CWT</div>
      <div style="font-size:14px;color:var(--muted)">Extraire tendance + r√©sidu. CWT pour d√©tecter les √©volutions fr√©quentielles.</div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--accent3);border-radius:8px;padding:16px">
      <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent3);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">√âtape 3 ¬∑ Corr√©ler</div>
      <div style="font-family:'Syne',sans-serif;font-weight:600;margin-bottom:8px">CCF sur r√©sidu</div>
      <div style="font-size:14px;color:var(--muted)">Corr√©lation avec for√ßants. Estimer d√©lais. Tester significativit√©.</div>
    </div>
  </div>
  <div class="note">‚ö†Ô∏è <span><strong>Pi√®ges</strong> : (1) Corr√©lation ‚â† causalit√©. (2) Ne jamais corr√©later des s√©ries avec tendance sans d√©saisonnalisation. (3) Les effets atmosph√©riques InSAR peuvent mimer des signaux hydrologiques. (4) Bords temporels du scalogramme CWT = c√¥ne d'influence (moins fiable).</span></div>
</div>

</div><!-- /container -->

<script>
// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function randn() {
  let u=0,v=0;
  while(!u)u=Math.random(); while(!v)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function linspace(a,b,n){const r=[];for(let i=0;i<n;i++)r.push(a+(b-a)*i/(n-1));return r;}

function nextPow2(n){let p=1;while(p<n)p*=2;return p;}
function fftRec(re,im){
  const n=re.length;if(n===1)return;
  const re_e=[],im_e=[],re_o=[],im_o=[];
  for(let i=0;i<n/2;i++){re_e.push(re[2*i]);im_e.push(im[2*i]);re_o.push(re[2*i+1]);im_o.push(im[2*i+1]);}
  fftRec(re_e,im_e);fftRec(re_o,im_o);
  for(let k=0;k<n/2;k++){
    const a=-2*Math.PI*k/n,c=Math.cos(a),s=Math.sin(a);
    const tr=c*re_o[k]-s*im_o[k],ti=c*im_o[k]+s*re_o[k];
    re[k]=re_e[k]+tr;im[k]=im_e[k]+ti;re[k+n/2]=re_e[k]-tr;im[k+n/2]=im_e[k]-ti;
  }
}
function computeFFT(sig){
  const n=nextPow2(sig.length);
  const re=sig.slice().concat(new Array(n-sig.length).fill(0)),im=new Array(n).fill(0);
  fftRec(re,im);
  return re.map((r,i)=>Math.sqrt(r*r+im[i]*im[i]));
}

function loess(x,y,bw){
  const n=y.length,sm=new Array(n),hw=Math.round(n*bw/2);
  for(let i=0;i<n;i++){
    const lo=Math.max(0,i-hw),hi=Math.min(n-1,i+hw),md=Math.max(Math.abs(i-lo),Math.abs(i-hi));
    let sw=0,swx=0,swy=0,swxx=0,swxy=0;
    for(let j=lo;j<=hi;j++){const u=Math.abs(i-j)/(md+1e-10),w=Math.pow(1-u*u*u,3);
      sw+=w;swx+=w*x[j];swy+=w*y[j];swxx+=w*x[j]*x[j];swxy+=w*x[j]*y[j];}
    const det=sw*swxx-swx*swx;
    if(Math.abs(det)<1e-10){sm[i]=swy/sw;}
    else{const b=(sw*swxy-swx*swy)/det;sm[i]=(swy-b*swx)/sw+b*x[i];}
  }
  return sm;
}

function crossCorr(x,y){
  const n=x.length,mx=x.reduce((a,b)=>a+b,0)/n,my=y.reduce((a,b)=>a+b,0)/n;
  const sx=Math.sqrt(x.reduce((a,b)=>a+(b-mx)**2,0)/n),sy=Math.sqrt(y.reduce((a,b)=>a+(b-my)**2,0)/n);
  const xn=x.map(v=>(v-mx)/(sx||1)),yn=y.map(v=>(v-my)/(sy||1));
  const ccf=[],lags=[];
  for(let lag=-Math.floor(n/2);lag<=Math.floor(n/2);lag++){
    let s=0,c=0;
    for(let i=0;i<n;i++){const j=i+lag;if(j>=0&&j<n){s+=xn[i]*yn[j];c++;}}
    ccf.push(c>0?s/c:0);lags.push(lag);
  }
  return{ccf,lags};
}

const CD={responsive:true,maintainAspectRatio:true,animation:{duration:0},
  plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},
  scales:{x:{ticks:{color:'#64748b',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(30,45,69,0.5)'}},
          y:{ticks:{color:'#64748b',font:{family:'JetBrains Mono',size:10}},grid:{color:'rgba(30,45,69,0.5)'}}}};

function mkChart(id,data,opts={}){return new Chart(document.getElementById(id).getContext('2d'),{type:'line',data,options:{...CD,...opts}});}

window.addEventListener('scroll',()=>{
  const d=document.documentElement;
  const p=d.scrollHeight-d.clientHeight;
  document.getElementById('progressBar').style.width=(p>0?((d.scrollTop||document.body.scrollTop)/p*100):0)+'%';
});
function toggleAnswer(id){document.getElementById(id).classList.toggle('visible');}

// ‚îÄ‚îÄ CHART 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N1=150,t1=linspace(0,5,N1);
let c1;
function buildC1(){
  const tr=+document.getElementById('s1trend').value;
  const a1=+document.getElementById('s1amp1').value;
  const a2=+document.getElementById('s1amp2').value;
  const no=+document.getElementById('s1noise').value;
  document.getElementById('s1trendVal').textContent=tr;
  document.getElementById('s1amp1Val').textContent=a1;
  document.getElementById('s1amp2Val').textContent=a2;
  document.getElementById('s1noiseVal').textContent=no;
  const trend=t1.map(t=>tr*t);
  const seas=t1.map(t=>a1*Math.sin(2*Math.PI*t)+a2*Math.sin(4*Math.PI*t));
  const total=t1.map((_,i)=>trend[i]+seas[i]+no*randn());
  const lbs=t1.map(t=>t.toFixed(1));
  if(!c1){c1=mkChart('chart1',{labels:lbs,datasets:[
    {data:total,borderColor:'#38bdf8',borderWidth:1.5,pointRadius:1.5,tension:0.3},
    {data:trend,borderColor:'#f59e0b',borderWidth:2,borderDash:[6,4],pointRadius:0},
    {data:seas, borderColor:'#34d399',borderWidth:1.5,borderDash:[3,3],pointRadius:0}]});}
  else{c1.data.datasets[0].data=total;c1.data.datasets[1].data=trend;c1.data.datasets[2].data=seas;c1.update('none');}
}
['s1trend','s1amp1','s1amp2','s1noise'].forEach(id=>document.getElementById(id).addEventListener('input',buildC1));
buildC1();

// ‚îÄ‚îÄ CHART 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N2=256,t2=linspace(0,5,N2),dt2=5/N2;
let c2a,c2b;
function buildC2(){
  const f1=+document.getElementById('s2f1').value,a1=+document.getElementById('s2a1').value;
  const f2=+document.getElementById('s2f2').value,a2=+document.getElementById('s2a2').value;
  document.getElementById('s2f1Val').textContent=f1.toFixed(1);document.getElementById('s2a1Val').textContent=a1;
  document.getElementById('s2f2Val').textContent=f2.toFixed(1);document.getElementById('s2a2Val').textContent=a2;
  const sig=t2.map(t=>a1*Math.sin(2*Math.PI*f1*t)+a2*Math.sin(2*Math.PI*f2*t)+1.5*randn());
  const pow=computeFFT(sig),n=pow.length;
  const freqs=linspace(0,1/dt2/2,n/2);
  if(!c2a){
    c2a=mkChart('chart2a',{labels:t2.map(t=>t.toFixed(1)),datasets:[{data:sig,borderColor:'#38bdf8',borderWidth:1,pointRadius:0,tension:0}]});
    c2b=mkChart('chart2b',{labels:freqs.map(f=>f.toFixed(1)),datasets:[{data:pow.slice(0,n/2),borderColor:'#f472b6',borderWidth:1.5,pointRadius:0,fill:true,backgroundColor:'rgba(244,114,182,0.05)'}]},
      {scales:{...CD.scales,x:{...CD.scales.x,title:{display:true,text:'f (c/an)',color:'#64748b',font:{size:10}}}}});}
  else{c2a.data.datasets[0].data=sig;c2b.data.datasets[0].data=pow.slice(0,n/2);c2a.update('none');c2b.update('none');}
}
['s2f1','s2a1','s2f2','s2a2'].forEach(id=>document.getElementById(id).addEventListener('input',buildC2));
buildC2();

// ‚îÄ‚îÄ CHART 3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N3=120,t3=linspace(0,4,N3);
let c3,n3cache=Array.from({length:N3},()=>randn());
function buildC3(){
  const win=+document.getElementById('s3win').value,no=+document.getElementById('s3noise').value,tp=document.getElementById('s3type').value;
  document.getElementById('s3winVal').textContent=win;document.getElementById('s3noiseVal').textContent=no;
  let tr;
  if(tp==='linear')tr=t3.map(t=>-5*t);
  else if(tp==='break')tr=t3.map(t=>t<2?-2*t:-4-8*(t-2));
  else tr=t3.map(t=>-t*t*2);
  const seas=t3.map(t=>8*Math.sin(2*Math.PI*t));
  const sig=t3.map((_,i)=>tr[i]+seas[i]+no*n3cache[i]);
  const bw=Math.max(0.05,Math.min(0.95,win/48));
  const est=loess(t3,sig,bw);
  const lbs=t3.map(t=>t.toFixed(1));
  if(!c3){c3=mkChart('chart3',{labels:lbs,datasets:[
    {data:sig,borderColor:'#475569',borderWidth:1,pointRadius:1,tension:0},
    {data:tr, borderColor:'#f59e0b',borderWidth:2,borderDash:[6,3],pointRadius:0},
    {data:est,borderColor:'#38bdf8',borderWidth:2.5,pointRadius:0,tension:0.3}]});}
  else{c3.data.datasets[0].data=sig;c3.data.datasets[1].data=tr;c3.data.datasets[2].data=est;c3.update('none');}
}
['s3win','s3noise','s3type'].forEach(id=>document.getElementById(id).addEventListener('input',buildC3));
buildC3();

// ‚îÄ‚îÄ CHART 4 ‚Äî CWT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N4=300, T4=6, dt4=T4/N4;
const t4=linspace(0,T4,N4);

// Morlet wavelet (real part) convolution approximation
// We implement a proper time-domain Morlet CWT
function morletWavelet(t, scale, omega0=6){
  // œà(t/scale) = œÄ^(-1/4) * exp(i*œâ0*t/scale) * exp(-t¬≤/(2*scale¬≤))
  const s=scale, gauss=Math.exp(-t*t/(2*s*s));
  const re=gauss*Math.cos(omega0*t/s);
  const im=gauss*Math.sin(omega0*t/s);
  return{re,im};
}

function computeCWT(signal, dt, omega0=6, n_scales=40, freq_min=0.3, freq_max=4.0){
  const n=signal.length;
  const freqs=linspace(freq_min,freq_max,n_scales);
  // scale = omega0 / (2*pi*f*dt)
  const scales=freqs.map(f=>omega0/(2*Math.PI*f*dt));
  const power=[];

  for(let si=0;si<n_scales;si++){
    const sc=scales[si];
    const rowPow=new Array(n).fill(0);
    // Convolution in time domain (simplified ‚Äî subsample wavelet to signal length)
    const half=Math.min(Math.floor(3*sc),Math.floor(n/2));
    for(let t_idx=0;t_idx<n;t_idx++){
      let sumRe=0,sumIm=0;
      for(let k=-half;k<=half;k++){
        const j=t_idx+k;
        if(j<0||j>=n)continue;
        const tt=k*dt;
        const{re,im}=morletWavelet(tt,sc*dt,omega0);
        sumRe+=signal[j]*re;
        sumIm+=signal[j]*im;
      }
      rowPow[t_idx]=(sumRe*sumRe+sumIm*sumIm)/(sc*dt);
    }
    power.push(rowPow);
  }
  return{power,freqs,scales};
}

// Plasma colormap
function plasmaColor(v){
  // v in [0,1]
  const c=[
    [0.05,0.03,0.53],[0.27,0.00,0.61],[0.47,0.00,0.56],[0.63,0.03,0.47],
    [0.76,0.15,0.35],[0.87,0.30,0.22],[0.93,0.48,0.10],[0.95,0.65,0.05],
    [0.94,0.82,0.14],[0.94,0.98,0.38]
  ];
  const i=Math.min(c.length-2,Math.floor(v*(c.length-1)));
  const f=v*(c.length-1)-i;
  const r=c[i][0]+(c[i+1][0]-c[i][0])*f;
  const g=c[i][1]+(c[i+1][1]-c[i][1])*f;
  const b=c[i][2]+(c[i+1][2]-c[i][2])*f;
  return`rgb(${Math.round(r*255)},${Math.round(g*255)},${Math.round(b*255)})`;
}

function drawScalogram(canvasId, cwt_data){
  const canvas=document.getElementById(canvasId);
  const wrapper=canvas.parentElement;
  const W=wrapper.clientWidth-24;
  canvas.width=W; canvas.height=200;
  const ctx=canvas.getContext('2d');
  const{power,freqs}=cwt_data;
  const nf=power.length, nt=power[0].length;

  // Find global min/max for normalization
  let pmin=Infinity,pmax=-Infinity;
  for(let i=0;i<nf;i++)for(let j=0;j<nt;j++){if(power[i][j]<pmin)pmin=power[i][j];if(power[i][j]>pmax)pmax=power[i][j];}
  const prange=pmax-pmin||1;

  const cw=W/nt, ch=canvas.height/nf;

  for(let i=0;i<nf;i++){
    for(let j=0;j<nt;j++){
      const v=(power[i][j]-pmin)/prange;
      ctx.fillStyle=plasmaColor(v);
      // Draw from bottom (low freq) to top (high freq) ‚Äî invert i
      ctx.fillRect(Math.floor(j*cw), Math.floor((nf-1-i)*ch), Math.ceil(cw)+1, Math.ceil(ch)+1);
    }
  }

  // White dashed line at t=half
  ctx.strokeStyle='rgba(255,255,255,0.6)';
  ctx.setLineDash([6,4]);
  ctx.lineWidth=1.5;
  ctx.beginPath();
  const xmid=Math.floor(W/2);
  ctx.moveTo(xmid,0); ctx.lineTo(xmid,canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);

  // Frequency labels (right side)
  ctx.fillStyle='rgba(100,116,139,0.9)';
  ctx.font='10px JetBrains Mono, monospace';
  ctx.textAlign='right';
  for(const f of [1,2,3]){
    const f_norm=(f-freqs[0])/(freqs[freqs.length-1]-freqs[0]);
    const y_px=canvas.height*(1-f_norm);
    if(y_px>10&&y_px<canvas.height-5){
      ctx.fillText(`${f} c/an`, W-4, y_px+3);
      ctx.strokeStyle='rgba(255,255,255,0.25)';
      ctx.lineWidth=1;
      ctx.setLineDash([3,3]);
      ctx.beginPath(); ctx.moveTo(0,y_px); ctx.lineTo(W,y_px); ctx.stroke();
      ctx.setLineDash([]);
    }
  }
}

let c4sig,c4fft1,c4fft2;
let cwtTimer=null;

function buildC4(){
  const f1=+document.getElementById('s4f1').value;
  const f2=+document.getElementById('s4f2').value;
  const amp=+document.getElementById('s4amp').value;
  const no=+document.getElementById('s4noise').value;

  document.getElementById('s4f1Val').textContent=f1.toFixed(1);
  document.getElementById('s4f2Val').textContent=f2.toFixed(1);
  document.getElementById('s4ampVal').textContent=amp;
  document.getElementById('s4noiseVal').textContent=no;

  const half=Math.floor(N4/2);
  const sig=t4.map((t,i)=>{
    const base=i<half?amp*Math.sin(2*Math.PI*f1*t):amp*Math.sin(2*Math.PI*f2*t);
    return base-3*t+no*randn();
  });

  // Signal chart
  const lbs=t4.map(t=>t.toFixed(1));
  if(!c4sig){
    c4sig=mkChart('chart4sig',{labels:lbs,datasets:[
      {data:sig,borderColor:'#38bdf8',borderWidth:1,pointRadius:0,tension:0}
    ]},{scales:{...CD.scales,
      x:{...CD.scales.x,title:{display:true,text:'Temps (ann√©es)',color:'#64748b',font:{size:10}}},
      y:{...CD.scales.y,title:{display:true,text:'LOS (mm)',color:'#64748b',font:{size:10}}}}});
  } else {
    c4sig.data.datasets[0].data=sig;
    c4sig.update('none');
  }

  // FFT on each half
  const sig1=sig.slice(0,half), sig2=sig.slice(half);
  const pow1=computeFFT(sig1.slice(0,nextPow2(sig1.length)));
  const pow2=computeFFT(sig2.slice(0,nextPow2(sig2.length)));
  const n1=pow1.length,n2=pow2.length;
  const freqs1=linspace(0,1/(dt4)/2,n1/2);
  const freqs2=linspace(0,1/(dt4)/2,n2/2);
  const fLbs1=freqs1.map(f=>f.toFixed(1));
  const fLbs2=freqs2.map(f=>f.toFixed(1));

  if(!c4fft1){
    c4fft1=mkChart('chart4fft1',{labels:fLbs1,datasets:[{data:pow1.slice(0,n1/2),borderColor:'#f472b6',borderWidth:1.5,pointRadius:0,fill:true,backgroundColor:'rgba(244,114,182,0.05)'}]},
      {scales:{...CD.scales,x:{...CD.scales.x,title:{display:true,text:'f (c/an)',color:'#64748b',font:{size:9}}}}});
    c4fft2=mkChart('chart4fft2',{labels:fLbs2,datasets:[{data:pow2.slice(0,n2/2),borderColor:'#f59e0b',borderWidth:1.5,pointRadius:0,fill:true,backgroundColor:'rgba(245,158,11,0.05)'}]},
      {scales:{...CD.scales,x:{...CD.scales.x,title:{display:true,text:'f (c/an)',color:'#64748b',font:{size:9}}}}});
  } else {
    c4fft1.data.datasets[0].data=pow1.slice(0,n1/2);
    c4fft2.data.datasets[0].data=pow2.slice(0,n2/2);
    c4fft1.update('none');c4fft2.update('none');
  }

  // CWT with debounce (slow computation)
  if(cwtTimer) clearTimeout(cwtTimer);
  cwtTimer=setTimeout(()=>{
    const cwt_data=computeCWT(sig, dt4, 6, 50, 0.3, 4.0);
    drawScalogram('cwtCanvas', cwt_data);
  }, 80);
}

['s4f1','s4f2','s4amp','s4noise'].forEach(id=>document.getElementById(id).addEventListener('input',buildC4));
buildC4();

// ‚îÄ‚îÄ CHART 5 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const N5=150,t5=linspace(0,5,N5),dt5=5/N5;
let c5a,c5b,n5cache=Array.from({length:N5},()=>randn());
const FACTOR_LABELS={rain:'Pr√©cipitations (mm)',piezo:'Niveau pi√©zo (m)',snow:'Fonte neige (mm/j)'};

function buildC5(){
  const lag=+document.getElementById('s5lag').value,no=+document.getElementById('s5noise').value,tp=document.getElementById('s5type').value;
  document.getElementById('s5lagVal').textContent=lag;document.getElementById('s5noiseVal').textContent=no;
  const lagPts=Math.round(lag/12/dt5);
  let forc;
  if(tp==='rain')forc=t5.map(t=>50+40*Math.sin(2*Math.PI*t-0.5)+15*randn());
  else if(tp==='piezo')forc=t5.map(t=>5+3*Math.sin(2*Math.PI*t+0.3)+0.5*randn());
  else forc=t5.map(t=>30*Math.max(0,Math.sin(2*Math.PI*t))+5*randn());
  const insar=t5.map((_,i)=>{const j=i-lagPts;return(j>=0&&j<N5?-0.4*forc[j]:0)+no*n5cache[i];});
  const{ccf,lags}=crossCorr(insar,forc);
  const lagsM=lags.map(l=>(l*dt5*12).toFixed(1));
  let mx=0,mv=-Infinity;ccf.forEach((v,i)=>{if(Math.abs(v)>Math.abs(mv)){mv=v;mx=i;}});
  const estLag=+(lags[mx]*dt5*12).toFixed(1);
  const ci=(2/Math.sqrt(N5)).toFixed(3);
  const lbs=t5.map(t=>t.toFixed(1));
  if(!c5a){
    c5a=mkChart('chart5a',{labels:lbs,datasets:[
      {data:insar,borderColor:'#60a5fa',borderWidth:1.5,pointRadius:1,tension:0.3,yAxisID:'y'},
      {data:forc, borderColor:'#4ade80',borderWidth:1.5,pointRadius:0,tension:0.3,yAxisID:'y2'}
    ]},{scales:{x:CD.scales.x,y:{...CD.scales.y,position:'left',title:{display:true,text:'InSAR (mm)',color:'#60a5fa',font:{size:10}}},y2:{position:'right',grid:{drawOnChartArea:false},ticks:{color:'#4ade80',font:{family:'JetBrains Mono',size:10}},title:{display:true,text:FACTOR_LABELS[tp],color:'#4ade80',font:{size:10}}}}});
    c5b=mkChart('chart5b',{labels:lagsM,datasets:[
      {data:ccf,borderColor:'#f472b6',borderWidth:1.5,pointRadius:0,fill:true,backgroundColor:'rgba(244,114,182,0.04)'},
      {data:Array(ccf.length).fill(+ci), borderColor:'rgba(255,255,255,0.2)',borderWidth:1,borderDash:[4,4],pointRadius:0},
      {data:Array(ccf.length).fill(-+ci),borderColor:'rgba(255,255,255,0.2)',borderWidth:1,borderDash:[4,4],pointRadius:0}
    ]},{scales:{...CD.scales,x:{...CD.scales.x,title:{display:true,text:'D√©lai œÑ (mois)',color:'#64748b',font:{size:10}}},y:{...CD.scales.y,min:-1,max:1}}});
  } else {
    c5a.data.datasets[0].data=insar;c5a.data.datasets[1].data=forc;
    c5a.options.scales.y2.title.text=FACTOR_LABELS[tp];
    c5b.data.labels=lagsM;c5b.data.datasets[0].data=ccf;
    c5b.data.datasets[1].data=Array(ccf.length).fill(+ci);
    c5b.data.datasets[2].data=Array(ccf.length).fill(-+ci);
    c5a.update('none');c5b.update('none');
  }
}
['s5lag','s5noise','s5type'].forEach(id=>document.getElementById(id).addEventListener('input',buildC5));
buildC5();
</script>
</body>
</html>
